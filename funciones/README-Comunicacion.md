# Comunicacion CRUD Function

This Azure Function provides a complete CRUD (Create, Read, Update, Delete) API for managing messages in the `vt_mensajes` table.

## Database Schema

The function operates on the following table structure:

```sql
CREATE TABLE vt_mensajes (
  mensaje_id   BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  cliente_id   BIGINT NOT NULL,
  fecha_envio  TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW(),
  contenido    TEXT NOT NULL,
  estado       VARCHAR(20) NOT NULL DEFAULT 'ENVIADO',
  
  CONSTRAINT fk_mensaje_cliente
    FOREIGN KEY (cliente_id)
    REFERENCES vt_clientes (cliente_id)
);
```

## API Endpoints

### 1. GET - Retrieve Messages

#### Get All Messages
```
GET /api/Comunicacion
```

#### Get Message by ID
```
GET /api/Comunicacion?id={mensaje_id}
```

#### Get Messages by Client ID
```
GET /api/Comunicacion?cliente_id={cliente_id}
```

#### Get Messages by Status
```
GET /api/Comunicacion?estado={estado}
```

**Status values:** ENVIADO, ENTREGADO, LEÍDO, ERROR

### 2. POST - Create New Message

```
POST /api/Comunicacion
Content-Type: application/json

{
  "cliente_id": 1,
  "contenido": "Hola, este es un mensaje de prueba",
  "estado": "ENVIADO"
}
```

**Required fields:**
- `cliente_id`: ID of the client (must exist in vt_clientes table)
- `contenido`: Message content (text)

**Optional fields:**
- `estado`: Message status (defaults to "ENVIADO")
- `fecha_envio`: Send date (defaults to current timestamp)

### 3. PUT - Update Message

```
PUT /api/Comunicacion?id={mensaje_id}
Content-Type: application/json

{
  "cliente_id": 1,
  "contenido": "Mensaje actualizado",
  "estado": "ENTREGADO"
}
```

**Required fields:**
- `cliente_id`: ID of the client
- `contenido`: Message content
- `estado`: Message status

### 4. DELETE - Delete Message

```
DELETE /api/Comunicacion?id={mensaje_id}
```

## Response Formats

### Success Responses

**GET (Single Message):**
```json
{
  "mensaje_id": 1,
  "cliente_id": 1,
  "fecha_envio": "2024-01-15T10:30:00",
  "contenido": "Hola, este es un mensaje de prueba",
  "estado": "ENVIADO"
}
```

**GET (Multiple Messages):**
```json
[
  {
    "mensaje_id": 1,
    "cliente_id": 1,
    "fecha_envio": "2024-01-15T10:30:00",
    "contenido": "Hola, este es un mensaje de prueba",
    "estado": "ENVIADO"
  },
  {
    "mensaje_id": 2,
    "cliente_id": 1,
    "fecha_envio": "2024-01-15T11:00:00",
    "contenido": "Segundo mensaje",
    "estado": "ENTREGADO"
  }
]
```

**POST (Created Message):**
```json
{
  "mensaje_id": 3,
  "cliente_id": 1,
  "fecha_envio": "2024-01-15T12:00:00",
  "contenido": "Nuevo mensaje",
  "estado": "ENVIADO"
}
```

### Error Responses

**400 Bad Request:**
```json
"cliente_id es requerido"
```

**404 Not Found:**
```json
"Mensaje no encontrado con ID: 999"
```

**500 Internal Server Error:**
```json
"Error de conexión con la base de datos"
```

## Testing

Use the provided PowerShell test script to test all CRUD operations:

```powershell
.\test-comunicacion.ps1
```

Make sure the function is running locally before executing the tests.

## Status Values

The `estado` field accepts the following values:
- **ENVIADO**: Message has been sent
- **ENTREGADO**: Message has been delivered
- **LEÍDO**: Message has been read
- **ERROR**: Error occurred while sending/delivering the message

## Dependencies

- Java 8 or higher
- Azure Functions Core Tools
- PostgreSQL database connection
- Jackson library for JSON serialization/deserialization

## Files

- `MensajeDTO.java`: Data Transfer Object for message entities
- `DatabaseService.java`: Database operations and connection management
- `Function.java`: Azure Function implementation with HTTP triggers
- `test-comunicacion.ps1`: PowerShell test script
