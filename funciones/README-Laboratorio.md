# Laboratorio CRUD API

This Azure Function provides a complete CRUD (Create, Read, Update, Delete) API for managing laboratory records in the `vt_laboratorio` table.

## Table Structure

The API interacts with the following database table:

```sql
CREATE TABLE vt_laboratorio (
  laboratorio_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  mascota_id     BIGINT NOT NULL,
  fecha          TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW(),
  examen         VARCHAR(200) NOT NULL,     -- e.g. "Hemograma", "Radiografía"
  resultado      TEXT NOT NULL,             -- description or findings
  valor          NUMERIC(10,2),             -- optional numeric result (e.g. blood sugar)
  unidad         VARCHAR(50),               -- optional unit (mg/dL, g/L, etc.)
  
  CONSTRAINT fk_laboratorio_mascota
    FOREIGN KEY (mascota_id)
    REFERENCES vt2_mascotas (mascota_id)
);
```

## API Endpoints

### Base URL
```
http://localhost:7071/api/Laboratorio
```

### 1. GET - Retrieve Laboratory Records

#### Get All Records
```
GET /api/Laboratorio
```

#### Get Record by ID
```
GET /api/Laboratorio?id={laboratorio_id}
```

#### Get Records by Pet ID
```
GET /api/Laboratorio?mascota_id={mascota_id}
```

#### Get Records by Exam Type
```
GET /api/Laboratorio?examen={examen_name}
```

### 2. POST - Create New Laboratory Record

```
POST /api/Laboratorio
Content-Type: application/json

{
  "mascota_id": 1,
  "examen": "Hemograma",
  "resultado": "Valores normales, glóbulos rojos y blancos dentro de rangos esperados",
  "valor": 12.5,
  "unidad": "g/dL"
}
```

**Required Fields:**
- `mascota_id` (Long): ID of the pet
- `examen` (String): Type of examination
- `resultado` (String): Description of results

**Optional Fields:**
- `fecha` (DateTime): Date and time of the exam (defaults to current timestamp)
- `valor` (BigDecimal): Numeric result value
- `unidad` (String): Unit of measurement

### 3. PUT - Update Laboratory Record

```
PUT /api/Laboratorio?id={laboratorio_id}
Content-Type: application/json

{
  "mascota_id": 1,
  "examen": "Hemograma Completo",
  "resultado": "Valores normales, glóbulos rojos y blancos dentro de rangos esperados. Plaquetas normales.",
  "valor": 12.8,
  "unidad": "g/dL"
}
```

### 4. DELETE - Delete Laboratory Record

```
DELETE /api/Laboratorio?id={laboratorio_id}
```

## Data Model

### LaboratorioDTO

```java
{
  "laboratorio_id": Long,        // Auto-generated primary key
  "mascota_id": Long,           // Foreign key to vt2_mascotas
  "fecha": "2024-01-15T10:30:00", // Timestamp
  "examen": "String",           // Examination type
  "resultado": "String",        // Results description
  "valor": BigDecimal,          // Optional numeric value
  "unidad": "String"            // Optional unit of measurement
}
```

## Example Usage

### Creating a Blood Test Record
```json
{
  "mascota_id": 1,
  "examen": "Hemograma",
  "resultado": "Valores normales, glóbulos rojos y blancos dentro de rangos esperados",
  "valor": 12.5,
  "unidad": "g/dL"
}
```

### Creating an X-Ray Record
```json
{
  "mascota_id": 2,
  "examen": "Radiografía",
  "resultado": "No se observan fracturas. Estructura ósea normal.",
  "valor": null,
  "unidad": null
}
```

### Creating a Urine Test Record
```json
{
  "mascota_id": 3,
  "examen": "Análisis de Orina",
  "resultado": "Densidad específica normal, pH ligeramente ácido, sin presencia de proteínas",
  "valor": 1.025,
  "unidad": "g/mL"
}
```

## Response Codes

- `200 OK`: Successful GET or PUT operation
- `201 Created`: Successful POST operation
- `204 No Content`: Successful DELETE operation
- `400 Bad Request`: Invalid request data or missing required fields
- `404 Not Found`: Record not found
- `500 Internal Server Error`: Database connection or server error

## Testing

Use the provided PowerShell test script to verify all CRUD operations:

```powershell
.\test-laboratorio.ps1
```

The test script will:
1. Create laboratory records
2. Retrieve all records
3. Get records by ID, pet ID, and exam type
4. Update existing records
5. Delete records
6. Verify operations

## Error Handling

The API includes comprehensive error handling for:
- Database connection issues
- Invalid JSON format
- Missing required fields
- Invalid ID formats
- Non-existent records
- Foreign key constraint violations

## Dependencies

- Java 11+
- Azure Functions Core Tools
- PostgreSQL JDBC Driver
- Jackson for JSON serialization
- Java Time Module for DateTime handling
